{"version":3,"file":"spruce.js","sources":["../src/utils.js","../src/observable.js","../src/index.js","../src/bus.js"],"sourcesContent":["export const domReady = () => {\n    return new Promise(resolve => {\n        if (document.readyState == \"loading\") {\n            document.addEventListener(\"DOMContentLoaded\", resolve)\n        } else {\n            resolve()\n        }\n    })\n}\n\nexport const buildInitExpression = el => {\n    let expression = \"$store = Spruce.subscribe($el)\"\n\n    if (el.hasAttribute('x-init')) {\n        expression = `${expression}; ${el.getAttribute('x-init')}`\n    }\n\n    return expression\n}\n\nexport const isNullOrUndefined = value => {\n    return value === null || value === undefined\n}","import { isNullOrUndefined } from './utils'\n\nexport const createObservable = (target, callbacks) => {\n    Object.keys(target).forEach(key => {\n        if (! isNullOrUndefined(target[key]) && Object.getPrototypeOf(target[key]) === Object.prototype) {\n            target[key] = createObservable(target[key], callbacks)\n        }\n    })\n\n    return new Proxy(target, {\n        get(target, key) {\n            if (callbacks.hasOwnProperty('get')) {\n                callbacks.get(key)\n            }\n            \n            return target[key]\n        },\n        set(target, key, value) {\n            const old = target[key]\n\n            if (! isNullOrUndefined(value) && typeof value === 'object') {\n                value = createObservable(value, callbacks)\n            }\n\n            callbacks.set(target, key, target[key] = value, old)\n\n            return true\n        }\n    })\n}","import { domReady, buildInitExpression, isNullOrUndefined } from './utils'\nimport { createObservable } from './observable'\nimport EventBus from './bus'\n\nconst Spruce = {\n    options: {\n        globalStoreVariable: false,\n    },\n\n    events: EventBus,\n\n    stores: {},\n\n    subscribers: [],\n\n    start: async function () {\n        await domReady()\n\n        this.emit('init')\n\n        document.querySelectorAll('[x-subscribe]').forEach(el => {\n            el.setAttribute('x-init', buildInitExpression(el))\n            el.removeAttribute('x-subscribe')\n        })\n\n        this.stores = createObservable(this.stores, {\n            set: (target, key, value, oldValue) => {\n                this.events.runWatchers(this.stores, target, key, oldValue)\n\n                this.updateSubscribers(key, value)\n            }\n        })\n\n        if (this.options.globalStoreVariable) {\n            document.querySelectorAll('[x-data]').forEach(el => {\n                if (! this.subscribers.includes(el)) {\n                    this.subscribers.push(el)\n                }\n            })\n            \n            window.$store = this.stores\n        }\n    },\n\n    store: function (name, state) {\n        if (! this.stores[name]) {\n            this.stores[name] = state\n        }\n\n        return this.stores[name]\n    },\n\n    subscribe(el) {\n        this.subscribers.push(el)\n\n        return this.stores\n    },\n\n    updateSubscribers(key, value) {\n        this.subscribers.forEach(el => {\n            if (el.__x !== undefined) {\n                el.__x.updateElements(el)\n            }\n        })\n    },\n\n    config(options = {}) {\n        this.options = Object.assign(this.options, options)\n    },\n\n    on(name, callback) {\n        return this.events.on(name, callback)\n    },\n\n    off(name, callback) {\n        this.events.off(name, callback)\n    },\n\n    emit(name, data = {}) {\n        this.events.emit(name, { ...data, store: this.stores })\n    },\n\n    watch(dotNotation, callback) {\n        this.events.watch(dotNotation, callback)\n    }\n}\n\nconst deferrer = window.deferLoadingAlpine || function (callback) { callback() }\n\nwindow.deferLoadingAlpine = function (callback) {\n    window.Spruce = Spruce\n    window.Spruce.start()\n\n    deferrer(callback)\n}\n\nexport default Spruce","export default {\n    watchers: {},\n\n    events: {},\n\n    on(name, callback) {\n        if (! this.events[name]) {\n            this.events[name] = []\n        }\n\n        this.events[name].push(callback)\n\n        return () => this.off(name, callback)\n    },\n\n    off(name, callback) {\n        this.events[name] = this.events[name].filter(registerCallback => {\n            return registerCallback !== callback\n        })\n    },\n\n    emit(name, data = {}) {\n        if (this.events[name]) {\n            this.events[name].forEach(callback => {\n                callback(data)\n            })\n        }\n\n        // TODO: deal with this for IE11 :(\n        // https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Browser_compatibility#Polyfill\n        window.dispatchEvent(new CustomEvent(`spruce:${name}`, {\n            detail: data,\n            bubbles: true\n        }))\n    },\n\n    watch(dotNotation, callback) {\n        if (! this.watchers[dotNotation]) {\n            this.watchers[dotNotation] = []\n        }\n\n        this.watchers[dotNotation].push(callback)\n    },\n\n    runWatchers(stores, target, key, oldValue) {\n        const self = this\n\n        if (self.watchers[key]) {\n            return self.watchers[key].forEach(callback => callback(oldValue, target[key]))\n        }\n\n        Object.keys(self.watchers)\n            .filter(watcher => watcher.includes('.'))\n            .forEach(fullDotNotationKey => {\n                let dotNotationParts = fullDotNotationKey.split('.')\n\n                if (key !== dotNotationParts[dotNotationParts.length - 1]) return\n\n                dotNotationParts.reduce((comparison, part) => {\n                    if (comparison[key] === target[key] || Object.is(target, comparison)) {\n                        self.watchers[fullDotNotationKey].forEach(callback => callback(oldValue, target[key]))\n                    }\n\n                    return comparison[part]\n                }, stores)\n            })\n    }\n}"],"names":["const","isNullOrUndefined","value","createObservable","target","callbacks","Object","keys","forEach","key","getPrototypeOf","prototype","Proxy","get","hasOwnProperty","set","old","Spruce","options","globalStoreVariable","events","watchers","on","name","callback","this","push","off","filter","registerCallback","emit","data","window","dispatchEvent","CustomEvent","detail","bubbles","watch","dotNotation","runWatchers","stores","oldValue","self","watcher","includes","fullDotNotationKey","dotNotationParts","split","length","reduce","comparison","part","is","subscribers","start","Promise","resolve","document","readyState","addEventListener","querySelectorAll","el","setAttribute","expression","hasAttribute","getAttribute","buildInitExpression","removeAttribute","_this","updateSubscribers","$store","store","state","subscribe","undefined","__x","updateElements","config","assign","deferrer","deferLoadingAlpine"],"mappings":"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"}