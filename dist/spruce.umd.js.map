{"version":3,"file":"spruce.umd.js","sources":["../src/utils.js","../src/observable.js","../src/index.js","../src/bus.js"],"sourcesContent":["export const domReady = () => {\n    return new Promise(resolve => {\n        if (document.readyState == \"loading\") {\n            document.addEventListener(\"DOMContentLoaded\", resolve)\n        } else {\n            resolve()\n        }\n    })\n}\n\nexport const buildInitExpression = el => {\n    let expression = \"$store = Spruce.subscribe($el)\"\n\n    if (el.hasAttribute('x-init')) {\n        expression = `${expression}; ${el.getAttribute('x-init')}`\n    }\n\n    return expression\n}\n\nexport const isNullOrUndefined = value => {\n    return value === null || value === undefined\n}\n\nexport const isObject = _ => {\n    return Object.getPrototypeOf(_) === Object.prototype\n}","import { isNullOrUndefined, isObject } from './utils'\n\nexport const createObservable = (target, callbacks) => {\n    Object.keys(target).forEach(key => {\n        if (! isNullOrUndefined(target[key]) && isObject(target[key])) {\n            target[key] = createObservable(target[key], callbacks)\n        }\n    })\n\n    return new Proxy(target, {\n        set(target, key, value) {\n            if (! isNullOrUndefined(value) && isObject(value)) {\n                value = createObservable(value, callbacks)\n            }\n\n            callbacks.set(target, key, target[key] = value)\n\n            return true\n        }\n    })\n}","import { domReady } from './utils'\nimport { createObservable } from './observable'\nimport EventBus from './bus'\n\nconst Spruce = {\n    events: EventBus,\n\n    stores: {},\n\n    subscribers: [],\n\n    async start() {\n        await domReady()\n\n        this.emit('init')\n        \n        this.attach()\n\n        document.addEventListener('turbolinks:render', this.attach)\n\n        this.stores = createObservable(this.stores, {\n            set: (target, key, value) => {\n                this.events.runWatchers(this.stores, target, key, value)\n\n                this.updateSubscribers()\n            }\n        })\n    },\n\n    attach() {\n        if (! window.Alpine) {\n            throw new Error('[Spruce] You must be using Alpine >= 2.5.0 to use Spruce.')\n        }\n\n        const self = this\n\n        window.Alpine.addMagicProperty('store', el => {\n            self.subscribe(el)\n\n            return self.stores\n        })\n    },\n\n    store(name, state) {\n        if (! this.stores[name]) {\n            this.stores[name] = state\n        }\n\n        return this.stores[name]\n    },\n\n    reset(name, state) {\n        this.stores[name] = state\n    },\n\n    subscribe(el) {\n        if (! this.subscribers.includes(el)) {\n            this.subscribers.push(el)\n        }\n\n        return this.stores\n    },\n\n    updateSubscribers() {\n        this.subscribers.filter(el => !! el.__x).forEach(el => {\n            el.__x.updateElements(el)\n        })\n    },\n\n    on(name, callback) {\n        return this.events.on(name, callback)\n    },\n\n    once(name, callback) {\n        return this.events.once(name, callback)\n    },\n\n    off(name, callback) {\n        this.events.off(name, callback)\n    },\n\n    emit(name, data = {}) {\n        this.events.emit(name, { ...data, store: this.stores })\n    },\n\n    watch(dotNotation, callback) {\n        this.events.watch(dotNotation, callback)\n    }\n}\n\nconst deferrer = window.deferLoadingAlpine || function (callback) { callback() }\n\nwindow.deferLoadingAlpine = function (callback) {\n    window.Spruce = Spruce\n    window.Spruce.start()\n\n    deferrer(callback)\n}\n\nexport default Spruce\n","export default {\n    watchers: {},\n\n    events: {},\n\n    on(name, callback, once = false) {\n        if (! this.events[name]) {\n            this.events[name] = []\n        }\n\n        this.events[name].push({ callback, once })\n\n        return () => this.off(name, callback)\n    },\n\n    once(name, callback) {\n        this.on(name, callback, true)\n    },\n\n    off(name, callback) {\n        this.events[name] = this.events[name].filter(registerCallback => {\n            return registerCallback.callback !== callback && registerCallback.once !== true\n        })\n    },\n\n    emit(name, data = {}) {\n        if (this.events[name]) {\n            this.events[name].forEach(callback => {\n                callback.callback(data)\n\n                if (callback.once) {\n                    this.off(name, callback)\n                }\n            })\n        }\n\n        // TODO: deal with this for IE11 :(\n        // https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Browser_compatibility#Polyfill\n        window.dispatchEvent(new CustomEvent(`spruce:${name}`, {\n            detail: data,\n            bubbles: true\n        }))\n    },\n\n    watch(dotNotation, callback) {\n        if (! this.watchers[dotNotation]) {\n            this.watchers[dotNotation] = []\n        }\n\n        this.watchers[dotNotation].push(callback)\n    },\n\n    runWatchers(stores, target, key, value) {\n        const self = this\n\n        if (self.watchers[key]) {\n            return self.watchers[key].forEach(callback => callback(value))\n        }\n\n        Object.keys(self.watchers)\n            .filter(watcher => watcher.includes('.'))\n            .forEach(fullDotNotationKey => {\n                let dotNotationParts = fullDotNotationKey.split('.')\n\n                if (key !== dotNotationParts[dotNotationParts.length - 1]) return\n\n                dotNotationParts.reduce((comparison, part) => {\n                    if (comparison[key] === target[key] || Object.is(target, comparison)) {\n                        self.watchers[fullDotNotationKey].forEach(callback => callback(value))\n                    }\n\n                    return comparison[part]\n                }, stores)\n            })\n    }\n}"],"names":["const","isNullOrUndefined","value","isObject","_","Object","getPrototypeOf","prototype","createObservable","target","callbacks","keys","forEach","key","Proxy","set","Spruce","events","watchers","on","name","callback","once","this","push","off","filter","registerCallback","emit","data","window","dispatchEvent","CustomEvent","detail","bubbles","watch","dotNotation","runWatchers","stores","self","watcher","includes","fullDotNotationKey","dotNotationParts","split","length","reduce","comparison","part","is","subscribers","start","Promise","resolve","document","readyState","addEventListener","attach","_this","updateSubscribers","Alpine","Error","addMagicProperty","el","subscribe","store","state","reset","__x","updateElements","deferrer","deferLoadingAlpine"],"mappings":"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"}